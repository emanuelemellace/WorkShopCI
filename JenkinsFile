/*
***

    This is an EXAMPLE of DECLARATIVE pipeline for the Build & Upload on Artifactory for Maven projects.
    It is possible that you need to customize your pipeline according to your project.

***
*/

pipeline {
    agent { label "master" }

    parameters {
        string(name: 'BRANCH', defaultValue: 'master')
        string(name: 'PROJECT_GIT_URL', defaultValue: 'https://github.com/emanuelemellace/WorkShopCI.git')
        credentials(name: 'GIT_CREDENTIALS', defaultValue: 'GIT_USER', credentialType: "Username with password", description: 'bitbucket.nexicloud.it credentials')
    }

    stages{
        stage('Checkout Maven project') {
            steps {
                cleanWs(deleteDirs: true)
                checkout([$class: 'GitSCM',
                branches: [[name: params.BRANCH]],
                gitTool: 'git',
                userRemoteConfigs: [[
                    credentialsId: params.GIT_CREDENTIALS,
                    url: params.PROJECT_GIT_URL
                ]]])
            }
        }

        stage('Build Maven project') {
            steps {
                withMaven(maven:'maven-3.3.9',
                mavenSettingsConfig: 'maven-3.3.9-settings-nexicloud.xml',
                mavenOpts: '-Xmx512m -XX:MaxPermSize=1024m'){
                    sh 'mvn -f pom.xml clean install'
                }
            }
        }

        stage('Unit tests'){
            steps {
                withMaven(maven:'maven-3.3.9', 
                mavenSettingsConfig: 'maven-3.3.9-settings-nexicloud.xml', 
                mavenOpts: '-Xmx512m -XX:MaxPermSize=1024m') {
                    sh 'mvn -f pom.xml clean test'
                }
            }
        }
        stage('SonarQube Analysis') {
            steps {
                withMaven(maven:'maven-3.3.9',
                mavenSettingsConfig: 'maven-3.3.9-settings-nexicloud.xml',
                mavenOpts: '-Xmx512m -XX:MaxPermSize=1024m'){
                    withSonarQubeEnv('SonarQube') {
                        sh 'mvn -f pom.xml sonar:sonar'
                    }
                }
            }
        }

        stage('Wait for Quality Gate') {
            steps {
                timeout(time: 5, unit: 'MINUTES') {
                    waitForQualityGate()
                }
            }
        }
       
        stage('Upload to Artifactory'){
            steps {
                withMaven(maven: 'maven-3.3.9', 
                mavenSettingsConfig: 'maven-3.3.9-settings-nexicloud.xml', 
                mavenOpts: '-Xmx512m -XX:MaxPermSize=1024m') {
                    sh 'mvn -f pom.xml deploy'
                    sh 'curl -o target/worshop-mellace-project.jar http://artifactory:8081/artifactory/example-repo-local/worshop-mellace-project.jar'
                }
            }
        }
		
    }

    post {
        always {
            emailext body: "<b>Number Build:</b><br> #${BUILD_NUMBER}<br><br><b>Result Build:</b><br>${currentBuild.currentResult}<br><br><b>Name Build:</b><br>${JOB_NAME}<br><br><b>URL Build:</b><br>${BUILD_URL}<br><br><b>Build Console URL:</b><br>${BUILD_URL}console", 
            mimeType: 'text/html', 
            subject: "${currentBuild.currentResult} BUILD: #${BUILD_NUMBER} ${JOB_NAME}", 
            to: 'example@mail.com'
        }
    }
*/
}